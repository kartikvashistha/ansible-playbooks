# vim:ft=yaml.ansible
# Run playbook via: ansible-playbook playbooks/kubernetes.yml --vault-password-file=bin/vault_passwd_file.sh
- name: Common tasks across all kubernetes hosts
  hosts: kubernetes
  vars_files: ../inventory/vault.yml
  roles:
    - role: fedora
    - role: dotfiles
    - role: neovim
    - role: kubernetes

- name: Specific tasks for kubernetes master nodes
  hosts: kubernetes_master_nodes
  vars_files: ../inventory/vault.yml
  tasks:
    - name: Create .kube directory
      ansible.builtin.file:
        state: directory
        path: "{{ ansible_env.HOME }}/.kube"
        mode: '0755'

    - name: Copy kube config file to home dir
      ansible.builtin.copy:
        remote_src: true
        src: /etc/kubernetes/admin.conf
        dest: "{{ ansible_env.HOME }}/.kube/config"
      become: true

    # No idea why this is not able to use my local kube config. Hence the above two tasks.
    - name: Install flannel for cluster wide networking
      kubernetes.core.k8s:
        definition: '{{ lookup("url", "https://raw.githubusercontent.com/flannel-io/flannel/{{ flannel_release_tag }}/Documentation/kube-flannel.yml", split_lines=False) | from_yaml_all | list }}'
        state: present

    - name: Taint master nodes to prevent application pods from running on it
      kubernetes.core.k8s_taint:
        name: "{{ item }}"
        state: present
        taints:
          - effect: NoSchedule 
            key: "node-role.kubernetes.io/control-plane"
      with_items: "{{ ansible_facts['hostname'] }}"
